
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RF Shimming 7T</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint single-page" id="site-navigation">
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/shimming-toolbox/rf-shimming-7t/main?urlpath=lab/tree/content/index.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>1     |     Data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="cell tag_remove_output tag_remove_input docutils container">
</div>
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=STIX+Two+Text:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
</head>
<p>
<center>
<b>
<h1>
Analysis code for the paper "RF shimming in the cervical spinal cord at 7T"
</h1>
</b>
<p style="text-align:center">
Daniel Papp<sup>1</sup>, Kyle M. Gilbert<sup>2,3</sup>, Gaspard Cereza<sup>1</sup>, Alexandre D’Astous<sup>1</sup>, Nibardo Lopez-Rios<sup>1</sup>, Mathieu Boudreau<sup>1</sup>, Marcus Couch<sup>4</sup>, Pedram Yazdanbakhsh<sup>5</sup>, Robert L. Barry<sup>6,7,8</sup>, Eva Alonso Ortiz<sup>1</sup>, Julien Cohen-Adad<sup>1,9,10</sup>
</p>
</b>
</center>
<p style="text-align:justify;font-size:70%">
<sup>1</sup>NeuroPoly Lab, Institute of Biomedical Engineering, Polytechnique Montreal, Montreal, QC, Canada,
<sup>2</sup> Centre for Functional and Metabolic Mapping, The University of Western Ontario, London, ON, Canada,
<sup>3</sup> Department of Medical Biophysics, The University of Western Ontario, London, ON, Canada,
<sup>4</sup> Siemens Healthcare Limited, Montreal, QC, Canada,
<sup>5</sup> McConnell Brain Imaging Centre, Montreal Neurological Institute, McGill University, Montreal, QC, Canada,
<sup>6</sup> Athinoula A. Martinos Center for Biomedical Imaging, Department of Radiology, Massachusetts General Hospital, Charlestown, MA, USA,
<sup>7</sup> Harvard Medical School, Boston, MA, USA,
<sup>8</sup> Harvard-Massachusetts Institute of Technology Health Sciences & Technology, Cambridge, MA, USA,
<sup>9</sup> Mila - Quebec AI Institute, Montreal, QC, Canada,
<sup>10</sup> Functional Neuroimaging Unit, Centre de recherche de l'Institut universitaire de gériatrie de Montréal QC, Canada
</p>
</p>
</p>
<center><h2>Summary</h2></center>
<p>Data was collected from five participants between two 7T sites with a custom 8Tx/20Rx parallel transmission (pTx) coil. We explored two RF shimming approaches from an MRI vendor and four from an open-source toolbox, showcasing their ability to enhance transmit field and signal homogeneity along the cervical spinal cord.</p>
<p>The results indicate significant improvements in B1+ efficiency and cerebrospinal fluid / spinal cord signal ratio across various RF shimming conditions compared to the vendor based methods.</p>
<p>The study’s findings highlight the potential of RF shimming to advance 7T MRI’s clinical utility for central nervous system imaging by enabling more homogenous and efficient spinal cord imaging. Additionally, the research incorporates a reproducible Jupyter Notebook, enhancing the study’s transparency and facilitating peer verification. By also making the data openly accessible on OpenNeuro, we ensure that the scientific community can further explore, validate, and build upon our findings, contributing to the collective advancement in high-resolution imaging techniques.</p>
<div class="figure align-center" id="fig1">
<a class="reference internal image-reference" href="_images/featured.png"><img alt="_images/featured.png" src="_images/featured.png" style="width: 900px;" /></a>
</div>
<p class="caption">
<b>Figure 1</b>. Overview of the RF shimming procedure. The top panel shows the RF coil used for the experiments, alongside the Tx coil geometry and the electromagnetic simulation results (on Gustav model) yielding the CP mode used for this coil. The bottom panel shows the RF shimming procedure (with approximate duration). First, GRE and tfl_rfmap scans are acquired (4min30s). Second, these images are transferred via ethernet socket from the MRI console onto a separate laptop running Shimming Toolbox and SCT (&#601s). Third, the spinal cord is automatically segmented to produce a mask that is resampled into the space of the individual coil magnitude and phase images of the tfl_rfmap scan (~5s). Fourth, the RF shim weights are calculated according to the defined constraints for each shim scenario (1min total).
</p><center><h2>Statement of Need</h2></center>
<p>Advancing the development of 7T MRI for spinal cord imaging is crucial for the enhanced diagnosis and monitoring of various neurodegenerative diseases <span id="id1">[<a class="reference internal" href="#id11" title="Hugh Kearney, David H Miller, and Olga Ciccarelli. Spinal cord MRI in multiple sclerosis–diagnostic, prognostic and clinical value. Nat. Rev. Neurol., 11(6):327–338, June 2015. doi:10.1038/nrneurol.2015.80.">Kearney <em>et al.</em>, 2015</a>]</span> and traumas <span id="id2">[<a class="reference internal" href="#id12" title="Gergely David, Siawoosh Mohammadi, Allan R Martin, Julien Cohen-Adad, Nikolaus Weiskopf, Alan Thompson, and Patrick Freund. Traumatic and nontraumatic spinal cord injury: pathological insights from neuroimaging. Nat. Rev. Neurol., 15(12):718–731, December 2019. doi:10.1038/s41582-019-0270-5.">David <em>et al.</em>, 2019</a>]</span>. However, a significant challenge at this field strength is the transmit field inhomogeneity <span id="id3">[<a class="reference internal" href="#id14" title="Christopher M Collins, Wanzhan Liu, Weston Schreiber, Qing X Yang, and Michael B Smith. Central brightening due to constructive interference with, without, and despite dielectric resonance. J. Magn. Reson. Imaging, 21(2):192–196, February 2005. doi:10.1002/jmri.20245.">Collins <em>et al.</em>, 2005</a>, <a class="reference internal" href="#id13" title="Tamer S Ibrahim, Robert Lee, Amir M Abduljalil, Brian A Baertlein, and Pierre-Marie L Robitaille. Dielectric resonances and b1 field inhomogeneity in uhfmri: computational analysis and experimental findings. Magnetic Resonance Imaging, 19(2):219-226, 2001. doi:10.1016/S0730-725X(01)00300-9.">Ibrahim <em>et al.</em>, 2001</a>, <a class="reference internal" href="#id15" title="P Röschmann. Radiofrequency penetration and absorption in the human body: limitations to high-field whole-body nuclear magnetic resonance imaging. Med. Phys., 14(6):922–931, November 1987. doi:10.1118/1.595995.">Röschmann, 1987</a>, <a class="reference internal" href="#id16" title="Qing X Yang, Jinghua Wang, Xiaoliang Zhang, Christopher M Collins, Michael B Smith, Haiying Liu, Xiao-Hong Zhu, J Thomas Vaughan, Kamil Ugurbil, and Wei Chen. Analysis of wave behavior in lossy dielectric samples at high field. Magn. Reson. Med., 47(5):982–989, May 2002. doi:10.1002/mrm.10137.">Yang <em>et al.</em>, 2002</a>]</span>. Such inhomogeneity is particularly problematic for imaging the small, deep anatomical structures of the cervical spinal cord , as it can cause uneven signal intensity and elevate the local specific absorption ratio, compromising image quality. This multi-site study explores several radiofrequency (RF) shimming techniques in the cervical spinal cord at 7T.</p>
<div class="tex2jax_ignore mathjax_ignore section" id="data">
<h1>1     |     Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h1>
<p>The data can be downloaded from: <a class="reference external" href="https://openneuro.org/datasets/ds004906">https://openneuro.org/datasets/ds004906</a></p>
<p>The structure of the input dataset is as follows (JSON sidecars are not listed for clarity):</p>
<div class="toggle docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ds004906
├── CHANGES
├── README
├── dataset_description.json
├── participants.json
├── participants.tsv
├── sub-01
│   ├── anat
│   │   ├── sub-01_acq-CP_T1w.nii.gz
│   │   ├── sub-01_acq-CP_T2starw.nii.gz
│   │   ├── sub-01_acq-CoV_T1w.nii.gz
│   │   ├── sub-01_acq-CoV_T2starw.nii.gz
│   │   ├── sub-01_acq-SAReff_T2starw.nii.gz
│   │   ├── sub-01_acq-patient_T2starw.nii.gz
│   │   ├── sub-01_acq-phase_T2starw.nii.gz
│   │   ├── sub-01_acq-target_T2starw.nii.gz
│   │   ├── sub-01_acq-volume_T2starw.nii.gz
│   └── fmap
│       ├── sub-01_acq-anatCP_TB1TFL.nii.gz
│       ├── sub-01_acq-anatCoV_TB1TFL.nii.gz
│       ├── sub-01_acq-anatSAReff_TB1TFL.nii.gz
│       ├── sub-01_acq-anatpatient_TB1TFL.nii.gz
│       ├── sub-01_acq-anatphase_TB1TFL.nii.gz
│       ├── sub-01_acq-anattarget_TB1TFL.nii.gz
│       ├── sub-01_acq-anatvolume_TB1TFL.nii.gz
│       ├── sub-01_acq-fampCP_TB1TFL.nii.gz
│       ├── sub-01_acq-fampCoV_TB1TFL.nii.gz
│       ├── sub-01_acq-fampSAReff_TB1TFL.nii.gz
│       ├── sub-01_acq-famppatient_TB1TFL.nii.gz
│       ├── sub-01_acq-fampphase_TB1TFL.nii.gz
│       ├── sub-01_acq-famptarget_TB1TFL.nii.gz
│       └── sub-01_acq-fampvolume_TB1TFL.nii.gz
├── sub-02
├── sub-03
├── sub-04
└── sub-05
</pre></div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="overview-of-processing-pipeline">
<h1>2     |     Overview of processing pipeline<a class="headerlink" href="#overview-of-processing-pipeline" title="Permalink to this headline">#</a></h1>
<p>During the data acquisition stage, RF shimming was done using the <a class="reference external" href="https://github.com/shimming-toolbox/shimming-toolbox">Shimming Toolbox</a> <span id="id4">[<a class="reference internal" href="#id9" title="Alexandre D'Astous, Gaspard Cereza, Daniel Papp, Kyle M. Gilbert, Jason P. Stockmann, Eva Alonso-Ortiz, and Julien Cohen-Adad. Shimming toolbox: an open-source software toolbox for b0 and b1 shimming in mri. Magnetic Resonance in Medicine, 89(4):1401-1417, 2023. doi:10.1002/mrm.29528.">D'Astous <em>et al.</em>, 2023</a>]</span> during the acquisition stage.</p>
<p>The post-processing pipeline uses the <a class="reference external" href="https://spinalcordtoolbox.com">Spinal Cord Toolbox</a> <span id="id5">[<a class="reference internal" href="#id10" title="Benjamin De Leener, Simon Lévy, Sara M. Dupont, Vladimir S. Fonov, Nikola Stikov, D. Louis Collins, Virginie Callot, and Julien Cohen-Adad. Sct: spinal cord toolbox, an open-source software for processing spinal cord \MRI\ data. NeuroImage, 145, Part A():24 - 43, 2017. doi:10.1016/j.neuroimage.2016.10.009.">De Leener <em>et al.</em>, 2017</a>]</span>.</p>
<p>For each subject:</p>
<ul class="simple">
<li><p>Process anat/T2starw (GRE)</p>
<ul>
<li><p>Segment the spinal cord (SC)</p></li>
<li><p>Label vertebral levels using existing manual disc labels</p></li>
<li><p>Create a mask of the cerebrospinal fluid (CSF)</p></li>
<li><p>Extract the SC/CSF magnitude signal to assess the stability of the flip angle across shim methods</p></li>
</ul>
</li>
<li><p>Process fmap/TFL (flip angle maps)</p>
<ul>
<li><p>Register each B1 map (CP, CoV, etc.) to the GRE scan</p></li>
<li><p>Apply the computed warping field to bring the segmentation and vertebral levels to the B1 map</p></li>
<li><p>Convert the B1 map to nT/V units</p></li>
<li><p>Extract the B1 map value within the SC</p></li>
</ul>
</li>
</ul>
<blockquote>
<div><p>Slow processes are indicated with the emoji ⏳</p>
</div></blockquote>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="requirements">
<h1>3     |     Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Install <a class="reference external" href="https://spinalcordtoolbox.com/user_section/installation.html">Spinal Cord Toolbox</a> <span id="id6">[<a class="reference internal" href="#id10" title="Benjamin De Leener, Simon Lévy, Sara M. Dupont, Vladimir S. Fonov, Nikola Stikov, D. Louis Collins, Virginie Callot, and Julien Cohen-Adad. Sct: spinal cord toolbox, an open-source software for processing spinal cord \MRI\ data. NeuroImage, 145, Part A():24 - 43, 2017. doi:10.1016/j.neuroimage.2016.10.009.">De Leener <em>et al.</em>, 2017</a>]</span>, eg</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install SCT ⏳</span>
!git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="w"> </span><span class="m">1</span><span class="w"> </span>https://github.com/spinalcordtoolbox/spinalcordtoolbox.git
!yes<span class="w"> </span><span class="p">|</span><span class="w"> </span>spinalcordtoolbox/install_sct
os.environ<span class="o">[</span><span class="s1">&#39;PATH&#39;</span><span class="o">]</span><span class="w"> </span>+<span class="o">=</span><span class="w"> </span>f<span class="s2">&quot;:/content/spinalcordtoolbox/bin&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Download the project repository</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/shimming-toolbox/rf-shimming-7t.git
<span class="nb">cd</span><span class="w"> </span>rf-shimming-7t
git<span class="w"> </span>checkout<span class="w"> </span>main
</pre></div>
</div>
<ul class="simple">
<li><p>Install requirements</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>binder/requirements.txt
</pre></div>
</div>
<ul class="simple">
<li><p>Download data</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>content
repo2data<span class="w"> </span>-r<span class="w"> </span>../binder/data_requirement.json
</pre></div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="environment-setup">
<h1>4     |     Environment setup<a class="headerlink" href="#environment-setup" title="Permalink to this headline">#</a></h1>
<p>In a Python shell:</p>
<p>Import the necessary modules.</p>
<div class="cell tag_remove_output tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">uniform_filter1d</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">f_oneway</span><span class="p">,</span> <span class="n">ttest_rel</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multicomp</span> <span class="kn">import</span> <span class="n">pairwise_tukeyhsd</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.anova</span> <span class="kn">import</span> <span class="n">AnovaRM</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_input tag_remove_output docutils container">
</div>
<div class="cell tag_remove_input tag_remove_output docutils container">
</div>
<div class="cell tag_remove_input tag_remove_output docutils container">
</div>
<p>Define variables.</p>
<div class="cell tag_hide_input tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;path_data: </span><span class="si">{</span><span class="n">path_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">path_labels</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="s2">&quot;derivatives&quot;</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">)</span>
<span class="n">path_qc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">)</span>
<span class="n">shim_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CP&quot;</span><span class="p">,</span> <span class="s2">&quot;patient&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="s2">&quot;CoV&quot;</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;SAReff&quot;</span><span class="p">]</span>
<span class="n">shim_modes_MPRAGE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CP&quot;</span><span class="p">,</span> <span class="s2">&quot;CoV&quot;</span><span class="p">]</span> 

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shim_modes: </span><span class="si">{</span><span class="n">shim_modes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;sub-*&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;subjects: </span><span class="si">{</span><span class="n">subjects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Create output folder</span>
<span class="n">path_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="process-anat-t2starw-gre">
<h1>5     |     Process anat/T2starw (GRE)<a class="headerlink" href="#process-anat-t2starw-gre" title="Permalink to this headline">#</a></h1>
<p>Run segmentation on GRE scan</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">))</span>
        <span class="c1"># The &quot;CoV&quot; RF shimming scenario was chosen as the segmentation baseline due to the more homogeneous signal intensity in the I--&gt;S direction, which results in a better segmentation peformance in the C7-T2 region</span>
        <span class="n">fname_manual_seg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_labels</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-CoV_T2starw_label-SC_seg.nii.gz&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname_manual_seg</span><span class="p">):</span>
            <span class="c1"># Manual segmentation already exists. Copy it to local folder</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">: Manual segmentation found</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">fname_manual_seg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-CoV_T2starw_seg.nii.gz&quot;</span><span class="p">)</span>
            <span class="c1"># Generate QC report to make sure the manual segmentation is correct</span>
            <span class="o">!</span>sct_qc<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw.nii.gz<span class="w"> </span>-s<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_seg.nii.gz<span class="w"> </span>-p<span class="w"> </span>sct_deepseg_sc<span class="w"> </span>-qc<span class="w"> </span><span class="o">{</span>path_qc<span class="o">}</span><span class="w"> </span>-qc-subject<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Manual segmentation does not exist. Run automatic segmentation.</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">: Manual segmentation not found&quot;</span><span class="p">)</span>
            <span class="o">!</span>sct_deepseg_sc<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw.nii.gz<span class="w"> </span>-c<span class="w"> </span>t2s<span class="w"> </span>-qc<span class="w"> </span><span class="o">{</span>path_qc<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>Copy CSF masks from the derivatives folder.</p>
<p>For more details about how these masks were created, see: <a class="reference external" href="https://github.com/shimming-toolbox/rf-shimming-7t/issues/67">https://github.com/shimming-toolbox/rf-shimming-7t/issues/67</a>.</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">))</span>
        <span class="n">fname_manual_seg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_labels</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-CoV_T2starw_label-CSF_seg.nii.gz&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname_manual_seg</span><span class="p">):</span>
            <span class="c1"># Manual segmentation already exists. Copy it to local folder</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">: Manual segmentation found</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">fname_manual_seg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-CoV_T2starw_label-CSF_seg.nii.gz&quot;</span><span class="p">)</span>
            <span class="c1"># Generate QC report to make sure the manual segmentation is correct</span>
            <span class="o">!</span>sct_qc<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw.nii.gz<span class="w"> </span>-s<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_label-CSF_seg.nii.gz<span class="w"> </span>-p<span class="w"> </span>sct_deepseg_sc<span class="w"> </span>-qc<span class="w"> </span><span class="o">{</span>path_qc<span class="o">}</span><span class="w"> </span>-qc-subject<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Manual segmentation does not exist. Panic!</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">: Manual segmentation not found 😱&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Crop GRE scan for faster processing and better registration results</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">))</span>
        <span class="o">!</span>sct_crop_image<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw.nii.gz<span class="w"> </span>-m<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_seg.nii.gz<span class="w"> </span>-dilate<span class="w"> </span>20x20x0<span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop.nii.gz
        <span class="o">!</span>sct_crop_image<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_seg.nii.gz<span class="w"> </span>-m<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_seg.nii.gz<span class="w"> </span>-dilate<span class="w"> </span>20x20x0<span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg.nii.gz
        <span class="o">!</span>sct_crop_image<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_label-CSF_seg.nii.gz<span class="w"> </span>-m<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_seg.nii.gz<span class="w"> </span>-dilate<span class="w"> </span>20x20x0<span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_label-CSF_seg.nii.gz
</pre></div>
</div>
</div>
</div>
<p>Label vertebrae on GRE scan</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given the low resolution of the GRE scan, the automatic detection of C2-C3 disc is unreliable. Therefore we need to use the manual disc labels that are part of the dataset.</span>
<span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">))</span>
        <span class="n">fname_label_discs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="s2">&quot;derivatives&quot;</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-CoV_T2starw_label-discs_dseg.nii.gz&quot;</span><span class="p">)</span>
        <span class="o">!</span>sct_label_utils<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg.nii.gz<span class="w"> </span>-disc<span class="w"> </span><span class="o">{</span>fname_label_discs<span class="o">}</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg_labeled.nii.gz
        <span class="c1"># Generate QC report to assess labeled segmentation</span>
        <span class="o">!</span>sct_qc<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop.nii.gz<span class="w"> </span>-s<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg_labeled.nii.gz<span class="w"> </span>-p<span class="w"> </span>sct_label_vertebrae<span class="w"> </span>-qc<span class="w"> </span><span class="o">{</span>path_qc<span class="o">}</span><span class="w"> </span>-qc-subject<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>Register *_T2starw to CoV_T2starw ⏳</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
            <span class="c1"># Don&#39;t do it for CoV_T2starw</span>
            <span class="k">if</span> <span class="n">shim_mode</span> <span class="o">!=</span> <span class="s1">&#39;CoV&#39;</span><span class="p">:</span>
                <span class="o">!</span>sct_register_multimodal<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-<span class="o">{</span>shim_mode<span class="o">}</span>_T2starw.nii.gz<span class="w"> </span>-d<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop.nii.gz<span class="w"> </span>-dseg<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg.nii.gz<span class="w"> </span>-param<span class="w"> </span><span class="nv">step</span><span class="o">=</span><span class="m">1</span>,type<span class="o">=</span>im,algo<span class="o">=</span>dl<span class="w"> </span>-qc<span class="w"> </span><span class="o">{</span>path_qc<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>Extract the signal intensity on the GRE scan within the spinal cord between levels C3 and T2 (included), which correspond to the region where RF shimming was prescribed.</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
            <span class="c1"># Shim methods are registered to the CoV T2starw scan, so we need to use the added suffix to identify them</span>
            <span class="k">if</span> <span class="n">shim_mode</span> <span class="o">==</span> <span class="s1">&#39;CoV&#39;</span><span class="p">:</span>
                <span class="n">file_suffix</span> <span class="o">=</span> <span class="s1">&#39;crop&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_suffix</span> <span class="o">=</span> <span class="s1">&#39;reg&#39;</span>
            <span class="n">fname_result_sc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_T2starw_label-SC.csv&quot;</span><span class="p">)</span>
            <span class="o">!</span>sct_extract_metric<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-<span class="o">{</span>shim_mode<span class="o">}</span>_T2starw_<span class="o">{</span>file_suffix<span class="o">}</span>.nii.gz<span class="w"> </span>-f<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg.nii.gz<span class="w"> </span>-method<span class="w"> </span>wa<span class="w"> </span>-vert<span class="w"> </span><span class="m">3</span>:9<span class="w"> </span>-vertfile<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg_labeled.nii.gz<span class="w"> </span>-perslice<span class="w"> </span><span class="m">1</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>fname_result_sc<span class="o">}</span>
            <span class="n">fname_result_csf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_T2starw_label-CSF.csv&quot;</span><span class="p">)</span>
            <span class="o">!</span>sct_extract_metric<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-<span class="o">{</span>shim_mode<span class="o">}</span>_T2starw_<span class="o">{</span>file_suffix<span class="o">}</span>.nii.gz<span class="w"> </span>-f<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_label-CSF_seg.nii.gz<span class="w"> </span>-method<span class="w"> </span>wa<span class="w"> </span>-vert<span class="w"> </span><span class="m">3</span>:9<span class="w"> </span>-vertfile<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg_labeled.nii.gz<span class="w"> </span>-perslice<span class="w"> </span><span class="m">1</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>fname_result_csf<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>Prepare data for figure  of CSF/SC signal ratio from T2starw scan</p>
<div class="cell tag_hide_input tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Go back to root data folder</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path_data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">smooth_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Apply a simple moving average to smooth the data. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">uniform_filter1d</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

<span class="c1"># Fixed grid for x-axis</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># z-slices corresponding to levels C3 to T2 on the PAM50 template. These will be used to scale the x-label of each subject.</span>
<span class="n">original_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">907</span><span class="p">,</span> <span class="mi">870</span><span class="p">,</span> <span class="mi">833</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">769</span><span class="p">,</span> <span class="mi">735</span><span class="p">,</span> <span class="mi">692</span><span class="p">,</span> <span class="mi">646</span><span class="p">])</span>

<span class="c1"># Normalize the PAM50 z-slice numbers to the 1-0 range (to show inferior-superior instead of superior-inferior)</span>
<span class="n">min_val</span> <span class="o">=</span> <span class="n">original_vector</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_val</span> <span class="o">=</span> <span class="n">original_vector</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">normalized_vector</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">original_vector</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">))</span>

<span class="c1"># Use this normalized vector as x-ticks</span>
<span class="n">custom_xticks</span> <span class="o">=</span> <span class="n">normalized_vector</span>

<span class="c1"># Vertebral level labels</span>
<span class="n">vertebral_levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&quot;</span><span class="p">,</span> <span class="s2">&quot;C6&quot;</span><span class="p">,</span> <span class="s2">&quot;C7&quot;</span><span class="p">,</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">]</span>
<span class="n">label_positions</span> <span class="o">=</span> <span class="n">normalized_vector</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">normalized_vector</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># Number of subjects determines the number of rows in the subplot</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>

<span class="c1"># Create a figure with multiple subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">))</span>
<span class="n">font_size</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">line_width</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Check if axes is an array or a single object</span>
<span class="k">if</span> <span class="n">n_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

<span class="c1"># Data storage for statistics</span>
<span class="n">data_stats</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Data storage for Plotly</span>
<span class="n">t2_data_plotly</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Initialize variables to find global min and max values</span>
<span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="c1"># First loop: find global min and max across all subjects and shim modes</span>
<span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
        <span class="n">file_csv_sc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_T2starw_label-SC.csv&quot;</span><span class="p">)</span>
        <span class="n">file_csv_csf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_T2starw_label-CSF.csv&quot;</span><span class="p">)</span>
        <span class="n">df_sc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_csv_sc</span><span class="p">)</span>
        <span class="n">df_csf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_csv_csf</span><span class="p">)</span>
        <span class="n">data_sc_smoothed</span> <span class="o">=</span> <span class="n">smooth_data</span><span class="p">(</span><span class="n">df_sc</span><span class="p">[</span><span class="s1">&#39;WA()&#39;</span><span class="p">])</span>
        <span class="n">data_csf_smoothed</span> <span class="o">=</span> <span class="n">smooth_data</span><span class="p">(</span><span class="n">df_csf</span><span class="p">[</span><span class="s1">&#39;WA()&#39;</span><span class="p">])</span>
        <span class="n">data_sc_csf_ratio</span> <span class="o">=</span> <span class="n">data_csf_smoothed</span> <span class="o">/</span> <span class="n">data_sc_smoothed</span>
        <span class="n">local_min</span><span class="p">,</span> <span class="n">local_max</span> <span class="o">=</span> <span class="n">data_sc_csf_ratio</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data_sc_csf_ratio</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">local_min</span> <span class="o">&lt;</span> <span class="n">global_min</span><span class="p">:</span>
            <span class="n">global_min</span> <span class="o">=</span> <span class="n">local_min</span>
        <span class="k">if</span> <span class="n">local_max</span> <span class="o">&gt;</span> <span class="n">global_max</span><span class="p">:</span>
            <span class="n">global_max</span> <span class="o">=</span> <span class="n">local_max</span>

<span class="c1"># Iterate over each subject and create a subplot</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subject</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subjects</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">t2_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
        <span class="c1"># Initialize list to collect data for this shim method</span>
        <span class="n">method_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get signal in SC</span>
        <span class="n">file_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_T2starw_label-SC.csv&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_csv</span><span class="p">)</span>
        <span class="n">data_sc</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;WA()&#39;</span><span class="p">]</span>
        <span class="n">data_sc_smoothed</span> <span class="o">=</span> <span class="n">smooth_data</span><span class="p">(</span><span class="n">data_sc</span><span class="p">)</span>

        <span class="c1"># Get signal in CSF</span>
        <span class="n">file_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_T2starw_label-CSF.csv&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_csv</span><span class="p">)</span>
        <span class="n">data_csf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;WA()&#39;</span><span class="p">]</span>
        <span class="n">data_csf_smoothed</span> <span class="o">=</span> <span class="n">smooth_data</span><span class="p">(</span><span class="n">data_csf</span><span class="p">)</span>
        
        <span class="c1"># Compute ratio</span>
        <span class="n">data_sc_csf_ratio</span> <span class="o">=</span> <span class="n">data_csf_smoothed</span> <span class="o">/</span> <span class="n">data_sc_smoothed</span>

        <span class="c1"># Normalize the x-axis to a 1-0 scale for each subject (to go from superior-inferior direction)</span>
        <span class="n">x_subject</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_sc_csf_ratio</span><span class="p">))</span>

        <span class="c1"># Interpolate to the fixed grid</span>
        <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x_subject</span><span class="p">,</span> <span class="n">data_sc_csf_ratio</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>

        <span class="n">method_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">)</span>

        <span class="c1"># If there&#39;s data for this shim method, plot it and compute stats</span>
        <span class="k">if</span> <span class="n">method_data</span><span class="p">:</span>
            <span class="n">t2_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="n">method_data</span>
        
            <span class="c1"># Plotting each file&#39;s data separately</span>
            <span class="k">for</span> <span class="n">resampled_data</span> <span class="ow">in</span> <span class="n">method_data</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">resampled_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_width</span><span class="p">)</span>

            <span class="c1"># Compute stats on the non-resampled data (to avoid interpolation errors)</span>
            <span class="n">mean_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_sc_csf_ratio</span><span class="p">)</span>
            <span class="n">sd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data_sc_csf_ratio</span><span class="p">)</span>
            <span class="n">data_stats</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">subject</span><span class="p">,</span> <span class="n">shim_mode</span><span class="p">,</span> <span class="n">mean_data</span><span class="p">,</span> <span class="n">sd_data</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t2_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>

    <span class="c1"># Set x-ticks and labels for the bottom subplot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Check if it&#39;s the last subplot</span>
        <span class="c1"># Create a secondary axis for vertebral level labels</span>
        <span class="n">secax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">label_positions</span><span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">vertebral_levels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Hide tick marks</span>

    <span class="c1"># Set y-axis to the same scale for all panels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">custom_xticks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_xticks</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Hide tick marks for the primary axis</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;CSF/Cord T2starw signal ratio&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">font_size</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Add legend only to the first subplot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Adjust the layout so labels and titles do not overlap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;fig_gre_csf-sc_ratio.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Perform statistics</p>
<div class="cell tag_hide_input tag_report_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform statistics</span>

<span class="c1"># Convert to DataFrame and save to CSV</span>
<span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_stats</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;Shim_Mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">])</span>
<span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;stats_t2starw.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Compute statistics across subjects</span>
<span class="n">grouped_means</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Average&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]})</span>

<span class="c1"># Format mean ± standard deviation</span>
<span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Average_formatted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ± &quot;</span> <span class="o">+</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Standard_Deviation_formatted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ± &quot;</span> <span class="o">+</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>

<span class="c1"># Drop multi-level index and only keep formatted columns</span>
<span class="n">grouped_means</span> <span class="o">=</span> <span class="n">grouped_means</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">])</span>
<span class="n">grouped_means</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">]</span>  <span class="c1"># Rename columns for clarity</span>
<span class="n">grouped_means</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;stats_t2starw_average_across_subjects.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Perform Repeated Measures ANOVA</span>
<span class="n">aovrm</span> <span class="o">=</span> <span class="n">AnovaRM</span><span class="p">(</span><span class="n">df_stats</span><span class="p">,</span> <span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">])</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">aovrm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="c1"># Perform Post Hoc paired t-tests</span>

<span class="c1"># Filter out subjects that don&#39;t have all shim modes</span>
<span class="n">shim_modes</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">valid_subjects</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">all</span><span class="p">(</span><span class="n">mode</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">))</span>

<span class="c1"># Pairwise comparisons</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">shim_modes</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="n">valid_subjects</span><span class="p">[</span><span class="n">valid_subjects</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Average&#39;</span><span class="p">]</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">valid_subjects</span><span class="p">[</span><span class="n">valid_subjects</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;Average&#39;</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ttest_rel</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="n">p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Function for Benjamini-Hochberg FDR correction</span>
<span class="k">def</span> <span class="nf">benjamini_hochberg</span><span class="p">(</span><span class="n">p_values</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
    <span class="n">sorted_p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
    <span class="n">adjusted_p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_p_values</span><span class="p">):</span>
        <span class="n">adjusted_p_values</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adjusted_p_values</span>

<span class="c1"># Applying Benjamini-Hochberg FDR correction</span>
<span class="n">adjusted_p_values</span> <span class="o">=</span> <span class="n">benjamini_hochberg</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>

<span class="c1"># Creating a summary DataFrame</span>
<span class="n">comparison_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Pair&#39;</span><span class="p">:</span> <span class="n">pairs</span><span class="p">,</span> <span class="s1">&#39;P-Value&#39;</span><span class="p">:</span> <span class="n">p_values</span><span class="p">,</span> <span class="s1">&#39;Adjusted P-Value&#39;</span><span class="p">:</span> <span class="n">adjusted_p_values</span><span class="p">})</span>

<span class="c1"># Save to CSV</span>
<span class="n">comparison_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;stats_t2starw_paired_ttest.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paired t-tests:</span><span class="se">\n</span><span class="si">{</span><span class="n">comparison_results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="process-fmap-tfl-flip-angle-maps">
<h1>6     |     Process fmap/TFL (flip angle maps)<a class="headerlink" href="#process-fmap-tfl-flip-angle-maps" title="Permalink to this headline">#</a></h1>
<p>Register TFL flip angle maps to the GRE scan ⏳</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
            <span class="o">!</span>sct_register_multimodal<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL.nii.gz<span class="w"> </span>-d<span class="w"> </span>../anat/<span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop.nii.gz<span class="w"> </span>-dseg<span class="w"> </span>../anat/<span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg.nii.gz<span class="w"> </span>-param<span class="w"> </span><span class="nv">step</span><span class="o">=</span><span class="m">1</span>,type<span class="o">=</span>im,algo<span class="o">=</span>slicereg,metric<span class="o">=</span>CC<span class="w"> </span>-qc<span class="w"> </span><span class="o">{</span>path_qc<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>Warping spinal cord segmentation and vertebral level to each flip angle map</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
            <span class="c1"># Use linear interpolation to preserve partial volume information (needed when extracting values along the cord)</span>
            <span class="o">!</span>sct_apply_transfo<span class="w"> </span>-i<span class="w"> </span>../anat/<span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg.nii.gz<span class="w"> </span>-d<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL.nii.gz<span class="w"> </span>-w<span class="w"> </span>warp_<span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop2<span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL.nii.gz<span class="w"> </span>-x<span class="w"> </span>linear<span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL_seg.nii.gz
            <span class="c1"># Use nearest neighbour (nn) interpolation because we are dealing with non-binary discrete labels</span>
            <span class="o">!</span>sct_apply_transfo<span class="w"> </span>-i<span class="w"> </span>../anat/<span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop_seg_labeled.nii.gz<span class="w"> </span>-d<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL.nii.gz<span class="w"> </span>-w<span class="w"> </span>warp_<span class="o">{</span>subject<span class="o">}</span>_acq-CoV_T2starw_crop2<span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL.nii.gz<span class="w"> </span>-x<span class="w"> </span>nn<span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL_seg_labeled.nii.gz
</pre></div>
</div>
</div>
</div>
<p>Convert the flip angle maps to B1+ efficiency maps [nT/V] (inspired by code from Kyle Gilbert).</p>
<p>The approach consists in calculating the B1+ efficiency using a 1ms, pi-pulse at the acquisition voltage, then scale the efficiency by the ratio of the measured flip angle to the requested flip angle in the pulse sequence.</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GAMMA</span> <span class="o">=</span> <span class="mf">2.675e8</span><span class="p">;</span>  <span class="c1"># [rad / (s T)]</span>
<span class="n">requested_fa</span> <span class="o">=</span> <span class="mi">90</span>  <span class="c1"># saturation flip angle -- hard-coded in sequence</span>

<span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
            <span class="c1"># Fetch the reference voltage from the JSON sidecar to the TFL B1map sequence</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-famp</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_TB1TFL.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">ref_voltage</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TxRefAmp&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ref_voltage [V]: </span><span class="si">{</span><span class="n">ref_voltage</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-famp</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_TB1TFL)&quot;</span><span class="p">)</span>

            <span class="c1"># Open flip angle map with nibabel</span>
            <span class="n">nii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-famp</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_TB1TFL.nii.gz&quot;</span><span class="p">)</span>
            <span class="n">acquired_fa</span> <span class="o">=</span> <span class="n">nii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

            <span class="c1"># Siemens maps are in units of flip angle * 10 (in degrees)</span>
            <span class="n">acquired_fa</span> <span class="o">=</span> <span class="n">acquired_fa</span> <span class="o">/</span> <span class="mi">10</span>

            <span class="c1"># Account for the power loss between the coil and the socket. That number was given by Siemens.</span>
            <span class="n">voltage_at_socket</span> <span class="o">=</span> <span class="n">ref_voltage</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.095</span>

            <span class="c1"># Compute B1 map in [T/V]</span>
            <span class="n">b1_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">acquired_fa</span> <span class="o">/</span> <span class="n">requested_fa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">GAMMA</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">voltage_at_socket</span><span class="p">))</span>

            <span class="c1"># Convert to [nT/V]</span>
            <span class="n">b1_map</span> <span class="o">=</span> <span class="n">b1_map</span> <span class="o">*</span> <span class="mf">1e9</span>

            <span class="c1"># Save as NIfTI file</span>
            <span class="n">nii_b1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">b1_map</span><span class="p">,</span> <span class="n">nii</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">nii</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nii_b1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_TB1map.nii.gz&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Extract B1+ value along the spinal cord between levels C3 and T2 (included)</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
            <span class="n">fname_result_b1plus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_TB1map_</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
            <span class="o">!</span>sct_extract_metric<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-<span class="o">{</span>shim_mode<span class="o">}</span>_TB1map.nii.gz<span class="w"> </span>-f<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL_seg.nii.gz<span class="w"> </span>-method<span class="w"> </span>wa<span class="w"> </span>-vert<span class="w"> </span><span class="m">3</span>:9<span class="w"> </span>-vertfile<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anat<span class="o">{</span>shim_mode<span class="o">}</span>_TB1TFL_seg_labeled.nii.gz<span class="w"> </span>-perslice<span class="w"> </span><span class="m">1</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>fname_result_b1plus<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>Prepare data for figure of B1+ values along the spinal cord across shim methods</p>
<div class="cell tag_hide_input tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Go back to root data folder</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">smooth_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Apply a simple moving average to smooth the data. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">uniform_filter1d</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

<span class="c1"># Fixed grid for x-axis</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># z-slices corresponding to levels C3 to T2 on the PAM50 template. These will be used to scale the x-label of each subject.</span>
<span class="n">original_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">907</span><span class="p">,</span> <span class="mi">870</span><span class="p">,</span> <span class="mi">833</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">769</span><span class="p">,</span> <span class="mi">735</span><span class="p">,</span> <span class="mi">692</span><span class="p">,</span> <span class="mi">646</span><span class="p">])</span>

<span class="c1"># Normalize the PAM50 z-slice numbers to the 1-0 range (to show inferior-superior instead of superior-inferior)</span>
<span class="n">min_val</span> <span class="o">=</span> <span class="n">original_vector</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_val</span> <span class="o">=</span> <span class="n">original_vector</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">normalized_vector</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">original_vector</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">))</span>

<span class="c1"># Use this normalized vector as x-ticks</span>
<span class="n">custom_xticks</span> <span class="o">=</span> <span class="n">normalized_vector</span>

<span class="c1"># Vertebral level labels</span>
<span class="n">vertebral_levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&quot;</span><span class="p">,</span> <span class="s2">&quot;C6&quot;</span><span class="p">,</span> <span class="s2">&quot;C7&quot;</span><span class="p">,</span> <span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">]</span>
<span class="c1"># Calculate midpoints for label positions</span>
<span class="n">label_positions</span> <span class="o">=</span> <span class="n">normalized_vector</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">normalized_vector</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># Number of subjects determines the number of rows in the subplot</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>

<span class="c1"># Create a figure with multiple subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">))</span>
<span class="n">font_size</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">line_width</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Check if axes is an array or a single object</span>
<span class="k">if</span> <span class="n">n_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

<span class="c1"># Data storage for statistics</span>
<span class="n">data_stats</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Data storage for Plotly</span>
<span class="n">b1_data_plotly</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Initialize variables to find global min and max values</span>
<span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="c1"># First loop: find global min and max across all subjects and shim modes</span>
<span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
        <span class="n">file_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_TB1map_</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_csv</span><span class="p">)</span>
        <span class="n">wa_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;WA()&#39;</span><span class="p">]</span>
        
        <span class="c1"># Check global min and max</span>
        <span class="n">local_min</span><span class="p">,</span> <span class="n">local_max</span> <span class="o">=</span> <span class="n">wa_data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">wa_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">local_min</span> <span class="o">&lt;</span> <span class="n">global_min</span><span class="p">:</span>
            <span class="n">global_min</span> <span class="o">=</span> <span class="n">local_min</span>
        <span class="k">if</span> <span class="n">local_max</span> <span class="o">&gt;</span> <span class="n">global_max</span><span class="p">:</span>
            <span class="n">global_max</span> <span class="o">=</span> <span class="n">local_max</span>

<span class="c1"># Iterate over each subject and create a subplot</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subject</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subjects</span><span class="p">):</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>
    <span class="n">b1_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
        <span class="c1"># Initialize list to collect data for this shim method</span>
        <span class="n">method_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">file_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_TB1map_</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_csv</span><span class="p">)</span>
        <span class="n">wa_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;WA()&#39;</span><span class="p">]</span>

        <span class="c1"># Normalize the x-axis to a 1-0 scale for each subject (to go from superior-inferior direction)</span>
        <span class="n">x_subject</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wa_data</span><span class="p">))</span>

        <span class="c1"># Interpolate to the fixed grid</span>
        <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x_subject</span><span class="p">,</span> <span class="n">wa_data</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">resampled_data</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>

        <span class="c1"># Apply smoothing</span>
        <span class="n">smoothed_data</span> <span class="o">=</span> <span class="n">smooth_data</span><span class="p">(</span><span class="n">resampled_data</span><span class="p">)</span>

        <span class="n">method_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smoothed_data</span><span class="p">)</span>

        <span class="c1"># If there&#39;s data for this shim method, plot it</span>
        <span class="k">if</span> <span class="n">method_data</span><span class="p">:</span>
            <span class="c1"># Plotting each file&#39;s data separately</span>
            <span class="k">for</span> <span class="n">resampled_data</span> <span class="ow">in</span> <span class="n">method_data</span><span class="p">:</span>
                <span class="n">b1_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="n">resampled_data</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">resampled_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_width</span><span class="p">)</span>

            <span class="c1"># Compute stats on the non-resampled data (to avoid interpolation errors)</span>
            <span class="n">mean_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wa_data</span><span class="p">)</span>
            <span class="n">sd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wa_data</span><span class="p">)</span>
            <span class="n">data_stats</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">subject</span><span class="p">,</span> <span class="n">shim_mode</span><span class="p">,</span> <span class="n">mean_data</span><span class="p">,</span> <span class="n">sd_data</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b1_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>

    <span class="c1"># Set x-ticks and labels for the bottom subplot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Check if it&#39;s the last subplot</span>
        <span class="c1"># Create a secondary axis for vertebral level labels</span>
        <span class="n">secax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">label_positions</span><span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">vertebral_levels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Hide tick marks</span>

    <span class="c1"># Set y-axis to the same scale for all panels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">custom_xticks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_xticks</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Hide tick marks for the primary axis</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;B1+ efficiency [nT/V]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">font_size</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Add legend only to the first subplot</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Adjust the layout so labels and titles do not overlap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;fig_b1plus.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Perform statistics</p>
<div class="cell tag_hide_input tag_report_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert to DataFrame and save to CSV</span>
<span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_stats</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;Shim_Mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">])</span>
<span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;stats_b1plus.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Compute statistics across subjects</span>
<span class="n">grouped_means</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Average&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]})</span>

<span class="c1"># Format mean ± standard deviation</span>
<span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Average_formatted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ± &quot;</span> <span class="o">+</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Standard_Deviation_formatted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ± &quot;</span> <span class="o">+</span> <span class="n">grouped_means</span><span class="p">[</span><span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>

<span class="c1"># Drop multi-level index and only keep formatted columns</span>
<span class="n">grouped_means</span> <span class="o">=</span> <span class="n">grouped_means</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">])</span>
<span class="n">grouped_means</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">]</span>  <span class="c1"># Rename columns for clarity</span>
<span class="n">grouped_means</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;stats_b1plus_average_across_subjects.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Perform Repeated Measures ANOVA</span>
<span class="n">aovrm</span> <span class="o">=</span> <span class="n">AnovaRM</span><span class="p">(</span><span class="n">df_stats</span><span class="p">,</span> <span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">])</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">aovrm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="c1"># Perform Post Hoc paired t-tests</span>

<span class="c1"># Filter out subjects that don&#39;t have all shim modes</span>
<span class="n">shim_modes</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">valid_subjects</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">all</span><span class="p">(</span><span class="n">mode</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">))</span>

<span class="c1"># Pairwise comparisons</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">shim_modes</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="n">valid_subjects</span><span class="p">[</span><span class="n">valid_subjects</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Average&#39;</span><span class="p">]</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">valid_subjects</span><span class="p">[</span><span class="n">valid_subjects</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;Average&#39;</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ttest_rel</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="n">p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Function for Benjamini-Hochberg FDR correction</span>
<span class="k">def</span> <span class="nf">benjamini_hochberg</span><span class="p">(</span><span class="n">p_values</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
    <span class="n">sorted_p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
    <span class="n">sorted_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
    <span class="n">adjusted_p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_p_values</span><span class="p">):</span>
        <span class="n">adjusted_p_values</span><span class="p">[</span><span class="n">sorted_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adjusted_p_values</span>

<span class="c1"># Applying Benjamini-Hochberg FDR correction</span>
<span class="n">adjusted_p_values</span> <span class="o">=</span> <span class="n">benjamini_hochberg</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>

<span class="c1"># Creating a summary DataFrame</span>
<span class="n">comparison_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Pair&#39;</span><span class="p">:</span> <span class="n">pairs</span><span class="p">,</span> <span class="s1">&#39;P-Value&#39;</span><span class="p">:</span> <span class="n">p_values</span><span class="p">,</span> <span class="s1">&#39;Adjusted P-Value&#39;</span><span class="p">:</span> <span class="n">adjusted_p_values</span><span class="p">})</span>

<span class="c1"># Save to CSV</span>
<span class="n">comparison_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;stats_b1plus_paired_ttest.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paired t-tests:</span><span class="se">\n</span><span class="si">{</span><span class="n">comparison_results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="paper-figures">
<h1>7     |     Paper figures<a class="headerlink" href="#paper-figures" title="Permalink to this headline">#</a></h1>
<p>Prepare RF shimming mask for figure</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select subject to show</span>
<span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;sub-05&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>

<span class="c1"># Create RF shimming mask from the segmentation (re-create the live RF shimming procedure)</span>
<span class="n">file_mask</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-anatCP_TB1TFL_mask-shimming.nii.gz&quot;</span>
<span class="k">if</span> <span class="s1">&#39;figures&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notebook</span><span class="p">:</span>

    <span class="o">!</span>sct_maths<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anatCP_TB1TFL_seg_labeled.nii.gz<span class="w"> </span>-thr<span class="w"> </span><span class="m">3</span><span class="w"> </span>-uthr<span class="w"> </span><span class="m">9</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>file_mask<span class="o">}</span>
    <span class="o">!</span>sct_maths<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>file_mask<span class="o">}</span><span class="w"> </span>-bin<span class="w"> </span><span class="m">1</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>file_mask<span class="o">}</span>
    <span class="o">!</span>sct_create_mask<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anatCP_TB1TFL.nii.gz<span class="w"> </span>-p<span class="w"> </span>centerline,<span class="o">{</span>file_mask<span class="o">}</span><span class="w"> </span>-size<span class="w"> </span>28mm<span class="w"> </span>-f<span class="w"> </span>cylinder<span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>file_mask<span class="o">}</span>

    <span class="c1"># Dilate mask</span>
    <span class="o">!</span>sct_maths<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>file_mask<span class="o">}</span><span class="w"> </span>-dilate<span class="w"> </span><span class="m">2</span><span class="w"> </span>-shape<span class="w"> </span>disk<span class="w"> </span>-dim<span class="w"> </span><span class="m">2</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anatCP_TB1TFL_mask-shimming_dil.nii.gz
    <span class="c1"># Subtract dilated mask with mask to get the edge</span>
    <span class="o">!</span>sct_maths<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>subject<span class="o">}</span>_acq-anatCP_TB1TFL_mask-shimming_dil.nii.gz<span class="w"> </span>-sub<span class="w"> </span><span class="o">{</span>file_mask<span class="o">}</span><span class="w"> </span>-o<span class="w"> </span><span class="o">{</span>file_mask<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<p>Create figure of B1+ maps</p>
<div class="cell tag_hide_input tag_report_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># Select subject to show</span>
<span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;sub-05&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;fmap&quot;</span><span class="p">))</span>
<span class="n">file_mask</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-anatCP_TB1TFL_mask-shimming.nii.gz&quot;</span>

<span class="c1"># Load the statistics from the CSV file</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;stats_b1plus.csv&#39;</span><span class="p">))</span>

<span class="c1"># Filter for the specific subject</span>
<span class="n">subject_stats</span> <span class="o">=</span> <span class="n">stats_df</span><span class="p">[</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">subject</span><span class="p">]</span>

<span class="c1"># Defining crop limits for resulting figure</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mi">110</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="mi">150</span>

<span class="c1"># Defining dynamic range</span>
<span class="n">dynmin</span> <span class="o">=</span> <span class="mi">5</span> 
<span class="n">dynmax</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># Create a figure with multiple subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">font_size</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># First, plot the anatomical image with an overlay of the mask</span>

<span class="c1"># Load data</span>
<span class="n">CP_anat</span><span class="o">=</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-anatCP_TB1TFL.nii.gz&quot;</span><span class="p">)</span>
<span class="n">CP_SC</span><span class="o">=</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_mask</span><span class="p">)</span>
<span class="n">CP_nTpV</span><span class="o">=</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-CP_TB1map.nii.gz&quot;</span><span class="p">)</span>

<span class="c1"># Defining mask based on the magnitude image intensity threshold</span>
<span class="n">cslice</span><span class="o">=</span><span class="n">CP_anat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span><span class="mi">2</span> <span class="c1">#shows the SC seg best</span>
<span class="n">threshold</span><span class="o">=</span><span class="mi">300</span>
<span class="n">mask</span><span class="o">=</span><span class="n">CP_anat</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">cslice</span><span class="p">]</span>
<span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Cropping anat, SC, B1+</span>
<span class="n">CP_anat</span><span class="o">=</span><span class="n">CP_anat</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">cslice</span><span class="p">]</span>
<span class="n">CP_anat</span><span class="o">=</span><span class="n">CP_anat</span><span class="o">*</span><span class="n">mask</span>
<span class="n">CP_SC</span><span class="o">=</span><span class="n">CP_SC</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">cslice</span><span class="p">]</span>
<span class="n">CP_nTpV</span><span class="o">=</span><span class="n">CP_nTpV</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">cslice</span><span class="p">]</span>
<span class="n">CP_nTpV</span><span class="o">=</span><span class="n">CP_nTpV</span><span class="o">*</span><span class="n">mask</span>

<span class="c1"># All opacity overalys look ugly: workaround, set the anat slice to a max value where the segmentation exists</span>
<span class="n">CP_anat</span><span class="p">[</span><span class="n">CP_SC</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">]</span><span class="o">=</span><span class="mi">4000</span><span class="p">;</span>

<span class="c1"># Plotting anat overlayed with SC</span>
<span class="n">splot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">splot</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">CP_anat</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span><span class="c1">#, interpolation=&#39;spline36&#39;)</span>
<span class="n">splot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Anat&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
<span class="n">splot</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># Then, plot each B1+ map, with an overlay of the mean and CV inside the cord</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">shim_mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shim_modes</span><span class="p">):</span>
    <span class="c1"># Load data</span>
    <span class="n">B1map</span><span class="o">=</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_acq-</span><span class="si">{</span><span class="n">shim_mode</span><span class="si">}</span><span class="s2">_TB1map.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">B1map</span><span class="o">=</span><span class="n">B1map</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">cslice</span><span class="p">]</span>
    <span class="n">B1map</span><span class="o">=</span><span class="n">B1map</span><span class="o">*</span><span class="n">mask</span>

    <span class="c1"># Plot</span>
    <span class="n">splot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">splot</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">B1map</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">dynmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">dynmax</span><span class="p">)</span><span class="c1">#, interpolation=&#39;spline36&#39;)</span>
    <span class="n">splot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">shim_mode</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
    <span class="n">splot</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># Find the statistics for the current shim mode</span>
    <span class="n">shim_stats</span> <span class="o">=</span> <span class="n">subject_stats</span><span class="p">[</span><span class="n">subject_stats</span><span class="p">[</span><span class="s1">&#39;Shim_Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">shim_mode</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shim_stats</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">mean_val</span> <span class="o">=</span> <span class="n">shim_stats</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Average&#39;</span><span class="p">]</span>
        <span class="n">std_val</span> <span class="o">=</span> <span class="n">shim_stats</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Standard_Deviation&#39;</span><span class="p">]</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">std_val</span> <span class="o">/</span> <span class="n">mean_val</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Coefficient of variation in percentage</span>
        <span class="n">annotation_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean_val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nT/V</span><span class="se">\n</span><span class="si">{</span><span class="n">cv</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="n">splot</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">annotation_text</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> 
                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> 
                       <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="c1"># Colorbar</span>
<span class="c1"># Assume that the colorbar should start at the bottom of the lower row of subplots and</span>
<span class="c1"># extend to the top of the upper row of subplots</span>
<span class="n">cbar_bottom</span> <span class="o">=</span> <span class="mf">0.06</span>  <span class="c1"># This might need adjustment</span>
<span class="n">cbar_height</span> <span class="o">=</span> <span class="mf">0.83</span>  <span class="c1"># This represents the total height of both rows of subplots</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.93</span><span class="p">,</span> <span class="n">cbar_bottom</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">cbar_height</span><span class="p">])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

<span class="c1"># cbar_ax = fig.add_axes([0.95, 0.5, 0.04, 0.4])</span>
<span class="c1"># cbar = plt.colorbar(im, cax=cbar_ax)</span>
<span class="n">cbar_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;nT/V&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;fig_b1plus_map.png&#39;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><b>Figure 2.</b> B1+ efficiency for one participant (sub-05) across all seven RF shimming conditions. The top left panel shows the tfl_b1map magnitude image with an overlay of the mask that was used to perform RF shimming. Text inserts show the mean (in nT/V) and CoV (in %) of B1+ efficiency along the spinal cord between C3 and T2.</p>
<div class="cell tag_hide_input tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># PYTHON CODE</span>
<span class="c1"># Module imports</span>

<span class="c1"># Base python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Graphical</span>

<span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">plotly</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">plotly.offline</span> <span class="kn">import</span> <span class="n">init_notebook_mode</span><span class="p">,</span> <span class="n">iplot</span><span class="p">,</span> <span class="n">plot</span>
<span class="n">config</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;showLink&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;displayModeBar&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;toImageButtonOptions&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="c1"># one of png, svg, jpeg, webp</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;custom_image&#39;</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="mi">2500</span><span class="p">,</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">1250</span><span class="p">,</span>
                <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="c1"># Multiply title/legend/axis/canvas sizes by this factor</span>
            <span class="p">}</span>
    <span class="p">}</span>

<span class="n">init_notebook_mode</span><span class="p">(</span><span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Set the color palette</span>
<span class="n">pal</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>

<span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="c1">## Setup for plots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">vertical_spacing</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span>
                    <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span>
    <span class="s1">&#39;&lt;b&gt;sub-01&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-01&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-02&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-02&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-03&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-03&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-04&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-04&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-05&lt;/b&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;b&gt;sub-05&lt;/b&gt;&#39;</span><span class="p">,))</span>

<span class="n">t2_datasets</span><span class="o">=</span><span class="p">{}</span>
<span class="n">b1_datasets</span><span class="o">=</span><span class="p">{}</span>

<span class="n">t2_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">b1_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">legend_bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t2_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">b1_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>

    <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
        <span class="n">t2_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">b1_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>

        <span class="n">t2_data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_grid</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">t2_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">shim_mode</span><span class="p">,</span>
            <span class="n">legendgroup</span><span class="o">=</span><span class="n">shim_mode</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="n">b1_data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_grid</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">b1_data_plotly</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">shim_mode</span><span class="p">,</span>
            <span class="n">legendgroup</span><span class="o">=</span><span class="n">shim_mode</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="n">legend_bool</span>
            <span class="p">)</span>        

        
        <span class="n">t2_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="n">t2_data</span>
        <span class="n">b1_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">]</span><span class="o">=</span><span class="n">b1_data</span>

        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">legend_bool</span><span class="o">=</span><span class="kc">False</span>
    

<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># For z-ordering   </span>
<span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">shim_mode</span> <span class="ow">in</span> <span class="n">shim_modes</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">t2_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">],</span>
            <span class="n">row</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">b1_datasets</span><span class="p">[</span><span class="n">subject</span><span class="p">][</span><span class="n">shim_mode</span><span class="p">],</span>
            <span class="n">row</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
    <span class="n">index</span><span class="o">+=</span><span class="mi">1</span>


<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">x_title</span> <span class="o">=</span> <span class="s1">&#39;&lt;b&gt;Vertebral Levels&lt;/b&gt;&#39;</span>
        <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">autorange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">x_title</span><span class="p">,</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;rgb(169,169,169)&#39;</span><span class="p">,</span>
        <span class="n">tickvals</span><span class="o">=</span><span class="n">label_positions</span><span class="p">,</span>
        <span class="n">ticktext</span><span class="o">=</span><span class="n">vertebral_levels</span><span class="p">,</span>
        <span class="n">showticklabels</span><span class="o">=</span><span class="n">showticklabels</span><span class="p">,</span>
        <span class="n">title_font_family</span><span class="o">=</span><span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span>
        <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;b&gt;CSF/Cord T&lt;sub&gt;2&lt;/sub&gt;&lt;sup&gt;*&lt;/sup&gt;w signal ratio&lt;/b&gt;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;standoff&#39;</span><span class="p">:</span><span class="mi">0</span>
                <span class="p">},</span>
            <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">],</span>
            <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;rgb(169,169,169)&#39;</span><span class="p">,</span>
            <span class="n">title_font_family</span><span class="o">=</span><span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span>
            <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;b&gt;CSF/Cord T&lt;sub&gt;2&lt;/sub&gt;&lt;sup&gt;*&lt;/sup&gt;w signal ratio&lt;/b&gt;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;standoff&#39;</span><span class="p">:</span><span class="mi">0</span>
                <span class="p">},</span>
            <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;rgb(169,169,169)&#39;</span><span class="p">,</span>
            <span class="n">title_font_family</span><span class="o">=</span><span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span>
            <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">autorange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">x_title</span><span class="p">,</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;rgb(169,169,169)&#39;</span><span class="p">,</span>
        <span class="n">tickvals</span><span class="o">=</span><span class="n">label_positions</span><span class="p">,</span>
        <span class="n">ticktext</span><span class="o">=</span><span class="n">vertebral_levels</span><span class="p">,</span>
        <span class="n">showticklabels</span><span class="o">=</span><span class="n">showticklabels</span><span class="p">,</span>
        <span class="n">title_font_family</span><span class="o">=</span><span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span>
        <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;b&gt;B&lt;sub&gt;1&lt;/sub&gt;&lt;sup&gt;+&lt;/sup&gt; efficiency [nT/V]&lt;/b&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;standoff&#39;</span><span class="p">:</span><span class="mi">0</span>
            <span class="p">},</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;rgb(169,169,169)&#39;</span><span class="p">,</span>
        <span class="n">title_font_family</span><span class="o">=</span><span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span>
        <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

    <span class="n">index</span><span class="o">+=</span><span class="mi">1</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">]:</span>
    <span class="n">i</span><span class="p">[</span><span class="s1">&#39;font&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
    <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">12</span>
    <span class="p">),</span>
    <span class="n">bordercolor</span><span class="o">=</span><span class="s2">&quot;Black&quot;</span><span class="p">,</span>
    <span class="n">borderwidth</span><span class="o">=</span><span class="mf">1.5</span>
    <span class="p">),</span>
    <span class="n">legend_tracegroupgap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">paper_bgcolor</span><span class="o">=</span><span class="s1">&#39;rgb(255, 255, 255)&#39;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;rgb(255, 255, 255)&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=-</span><span class="mf">0.06</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=-</span><span class="mf">0.03</span><span class="p">,</span>
            <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;A&lt;/b&gt;&#39;</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">48</span>
            <span class="p">),</span>
            <span class="n">xref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span>
            <span class="n">yref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span>
        <span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=-</span><span class="mf">0.03</span><span class="p">,</span>
            <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;B&lt;/b&gt;&#39;</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Times New Roman&#39;</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">48</span>
            <span class="p">),</span>
            <span class="n">xref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span>
            <span class="n">yref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span>
        <span class="p">),</span>
<span class="p">)</span>
<span class="c1">#iplot(fig, filename = &#39;figure3&#39;, config = config)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span><span class="s1">&#39;figure3.html&#39;</span><span class="p">),</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_input tag_report_output docutils container">
</div>
<p><b>Figure 3.</b> B<sub>1</sub><sup>+</sup> efficiency (A) and CSF/Cord signal ratio from the GRE scan (B) across subjects and across different RF shimming conditions. Data were measured in the spinal cord from C3 to T2 vertebral levels. To match the x-ticks across subjects, the C2-C3 and the T2-T3 intervertebral discs of each subject were aligned with that of the PAM50 template  <span id="id7">[<a class="reference internal" href="#id17" title="Benjamin De Leener, Vladimir S. Fonov, D. Louis Collins, Virginie Callot, Nikola Stikov, and Julien Cohen-Adad. Pam50: unbiased multimodal template of the brainstem and spinal cord aligned with the icbm152 space. NeuroImage, 165:170-179, 2018. doi:10.1016/j.neuroimage.2017.10.041.">De Leener <em>et al.</em>, 2018</a>]</span>, and the curves were linearly scaled.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h1>
<div class="docutils container" id="id8">
<dl class="citation">
<dt class="label" id="id14"><span class="brackets"><a class="fn-backref" href="#id3">1</a></span></dt>
<dd><p>Christopher M Collins, Wanzhan Liu, Weston Schreiber, Qing X Yang, and Michael B Smith. Central brightening due to constructive interference with, without, and despite dielectric resonance. <em>J. Magn. Reson. Imaging</em>, 21(2):192–196, February 2005. <a class="reference external" href="https://doi.org/10.1002/jmri.20245">doi:10.1002/jmri.20245</a>.</p>
</dd>
<dt class="label" id="id9"><span class="brackets"><a class="fn-backref" href="#id4">2</a></span></dt>
<dd><p>Alexandre D'Astous, Gaspard Cereza, Daniel Papp, Kyle M. Gilbert, Jason P. Stockmann, Eva Alonso-Ortiz, and Julien Cohen-Adad. Shimming toolbox: an open-source software toolbox for b0 and b1 shimming in mri. <em>Magnetic Resonance in Medicine</em>, 89(4):1401–1417, 2023. <a class="reference external" href="https://doi.org/10.1002/mrm.29528">doi:10.1002/mrm.29528</a>.</p>
</dd>
<dt class="label" id="id12"><span class="brackets"><a class="fn-backref" href="#id2">3</a></span></dt>
<dd><p>Gergely David, Siawoosh Mohammadi, Allan R Martin, Julien Cohen-Adad, Nikolaus Weiskopf, Alan Thompson, and Patrick Freund. Traumatic and nontraumatic spinal cord injury: pathological insights from neuroimaging. <em>Nat. Rev. Neurol.</em>, 15(12):718–731, December 2019. <a class="reference external" href="https://doi.org/10.1038/s41582-019-0270-5">doi:10.1038/s41582-019-0270-5</a>.</p>
</dd>
<dt class="label" id="id10"><span class="brackets">4</span><span class="fn-backref">(<a href="#id5">1</a>,<a href="#id6">2</a>)</span></dt>
<dd><p>Benjamin De Leener, Simon Lévy, Sara M. Dupont, Vladimir S. Fonov, Nikola Stikov, D. Louis Collins, Virginie Callot, and Julien Cohen-Adad. Sct: spinal cord toolbox, an open-source software for processing spinal cord \MRI\ data. <em>NeuroImage</em>, 145, Part A():24 – 43, 2017. <a class="reference external" href="https://doi.org/10.1016/j.neuroimage.2016.10.009">doi:10.1016/j.neuroimage.2016.10.009</a>.</p>
</dd>
<dt class="label" id="id13"><span class="brackets"><a class="fn-backref" href="#id3">5</a></span></dt>
<dd><p>Tamer S Ibrahim, Robert Lee, Amir M Abduljalil, Brian A Baertlein, and Pierre-Marie L Robitaille. Dielectric resonances and b1 field inhomogeneity in uhfmri: computational analysis and experimental findings. <em>Magnetic Resonance Imaging</em>, 19(2):219–226, 2001. <a class="reference external" href="https://doi.org/10.1016/S0730-725X(01)00300-9">doi:10.1016/S0730-725X(01)00300-9</a>.</p>
</dd>
<dt class="label" id="id11"><span class="brackets"><a class="fn-backref" href="#id1">6</a></span></dt>
<dd><p>Hugh Kearney, David H Miller, and Olga Ciccarelli. Spinal cord MRI in multiple sclerosis–diagnostic, prognostic and clinical value. <em>Nat. Rev. Neurol.</em>, 11(6):327–338, June 2015. <a class="reference external" href="https://doi.org/10.1038/nrneurol.2015.80">doi:10.1038/nrneurol.2015.80</a>.</p>
</dd>
<dt class="label" id="id15"><span class="brackets"><a class="fn-backref" href="#id3">7</a></span></dt>
<dd><p>P Röschmann. Radiofrequency penetration and absorption in the human body: limitations to high-field whole-body nuclear magnetic resonance imaging. <em>Med. Phys.</em>, 14(6):922–931, November 1987. <a class="reference external" href="https://doi.org/10.1118/1.595995">doi:10.1118/1.595995</a>.</p>
</dd>
<dt class="label" id="id16"><span class="brackets"><a class="fn-backref" href="#id3">8</a></span></dt>
<dd><p>Qing X Yang, Jinghua Wang, Xiaoliang Zhang, Christopher M Collins, Michael B Smith, Haiying Liu, Xiao-Hong Zhu, J Thomas Vaughan, Kamil Ugurbil, and Wei Chen. Analysis of wave behavior in lossy dielectric samples at high field. <em>Magn. Reson. Med.</em>, 47(5):982–989, May 2002. <a class="reference external" href="https://doi.org/10.1002/mrm.10137">doi:10.1002/mrm.10137</a>.</p>
</dd>
<dt class="label" id="id17"><span class="brackets"><a class="fn-backref" href="#id7">9</a></span></dt>
<dd><p>Benjamin De Leener, Vladimir S. Fonov, D. Louis Collins, Virginie Callot, Nikola Stikov, and Julien Cohen-Adad. Pam50: unbiased multimodal template of the brainstem and spinal cord aligned with the icbm152 space. <em>NeuroImage</em>, 165:170–179, 2018. <a class="reference external" href="https://doi.org/10.1016/j.neuroimage.2017.10.041">doi:10.1016/j.neuroimage.2017.10.041</a>.</p>
</dd>
</dl>
</div>
<div class="cell tag_remove_input tag_remove_output docutils container">
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Jupyter Book community<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>